import{R as P,r as i,j as b}from"./index-e439054e.js";import{h as C,m as O,E as A,o as X,k as z,a as $,w as D,S as L,I as M}from"./index.min-45331c48.js";import{g as Y}from"./Basic3dViewPanel-6892a15b.js";import{G as k}from"./constants-81f60586.js";const G=P.forwardRef((l,W)=>{const g=i.useRef(null),p=i.useRef(null);i.useRef(!1),i.useRef(null),i.useRef(null),i.useRef(null);const F=i.useRef(l);i.useLayoutEffect(()=>{F.current=l});const{levels:R,activeLevelIndex:c}=l,u="isReadOnly"in l&&l.isReadOnly,v=u?null:l.aiFixPreview,E=u?{}:l.liveSelections,I=u?{}:l.liveCursors,d=u?null:l.currentUser,x=i.useCallback(()=>{var m;const n=p.current;if(!n)return;const o=R[c];n.clear();const y="#334155";for(let e=0;e<(n.width||0)/(k*n.getZoom());e++)for(let t=0;t<(n.height||0)/(k*n.getZoom());t++){const r=new C({left:e*k,top:t*k,radius:.5,fill:y,selectable:!1,evented:!1,originX:"center",originY:"center"});n.add(r)}(o.walls||[]).forEach(e=>{const t=new O([e.x1,e.y1,e.x2,e.y2],{stroke:"#e2e8f0",strokeWidth:e.thickness,selectable:!0});t.data={id:e.id,type:"wall",levelIndex:c},n.add(t)}),(o.rooms||[]).forEach(e=>{if(!e.wallIds||e.wallIds.length===0)return;const t=e.wallIds.map(s=>o.walls.find(h=>h.id===s)).filter(Boolean);if(t.length===0)return;const r=t.flatMap(s=>[{x:s.x1,y:s.y1},{x:s.x2,y:s.y2}]),a=Array.from(new Map(r.map(s=>[`${s.x},${s.y}`,s])).values());if(a.length===0)return;const f=a.reduce((s,h)=>s+h.x,0)/a.length,w=a.reduce((s,h)=>s+h.y,0)/a.length,j=e.calculatedArea?`
${(e.calculatedArea/100).toFixed(1)} sq. ft.`:"",N=`${e.name}${j}`,S=new A(N,{left:f,top:w,originX:"center",originY:"center",fontSize:12,fill:"#94a3b8",textAlign:"center",selectable:!0,evented:!0});S.data={id:e.id,type:"room",levelIndex:c},n.add(S)}),(o.placements||[]).forEach(e=>{const t=o.walls.find(j=>j.id===e.wallId);if(!t)return;const r=new X(t.x2-t.x1,t.y2-t.y1),a=new X(t.x1+r.x*e.positionRatio,t.y1+r.y*e.positionRatio),f=z.radiansToDegrees(Math.atan2(r.y,r.x)),w=new $({left:a.x,top:a.y,width:e.width,height:t.thickness,fill:e.type==="door"?"#a78bfa":"#38bdf8",originX:"center",originY:"center",angle:f,selectable:!0});w.data={id:e.id,type:"placement",levelIndex:c},n.add(w)}),(o.comments||[]).forEach(e=>{const t=new C({left:e.x,top:e.y,radius:10,fill:e.resolved?"#10b981":"#f59e0b",originX:"center",originY:"center",selectable:!0});t.data={id:e.id,type:"comment",levelIndex:c},n.add(t)}),(o.zones||[]).forEach(e=>{const t={residential:"rgba(37, 99, 235, 0.5)",commercial:"rgba(245, 158, 11, 0.5)",green_space:"rgba(16, 185, 129, 0.5)"},r=new D(e.path,{fill:t[e.type]||"rgba(100, 116, 139, 0.5)",stroke:"#fff",strokeWidth:1,strokeDashArray:[3,3],selectable:!0});r.data={id:e.id,type:"zone",levelIndex:c},n.add(r)}),(o.infrastructure||[]).forEach(e=>{const t=new L(e.path,{stroke:"#64748b",strokeWidth:e.width||10,fill:"transparent",selectable:!0});t.data={id:e.id,type:"infrastructure",levelIndex:c},n.add(t)}),v&&((m=v.fix.addedWalls)==null||m.forEach(e=>{const t=new O([e.x1,e.y1,e.x2,e.y2],{stroke:"rgba(139, 92, 246, 0.7)",strokeWidth:10,strokeDashArray:[5,5],selectable:!1,evented:!1});n.add(t)})),Object.values(E).forEach(e=>{if(e.userId===(d==null?void 0:d.id))return;const t=n.getObjects().find(r=>{var a,f;return((a=r.data)==null?void 0:a.id)===((f=e.selection)==null?void 0:f.id)});t&&t.set({stroke:Y(e.userId),strokeWidth:t.strokeWidth+4})}),Object.entries(I||{}).forEach(([e,t])=>{if(e===(d==null?void 0:d.id)||t.x===void 0)return;const r=Y(e),a=new C({left:t.x,top:t.y,radius:5,fill:r,stroke:"#fff",strokeWidth:2,originX:"center",originY:"center",selectable:!1,evented:!1}),f=new A(t.userName,{left:t.x,top:t.y+15,fontSize:12,fill:r,originX:"center",originY:"center",selectable:!1,evented:!1});n.add(a,f)}),n.renderAll()},[R,c,v,E,I,d]);return i.useEffect(()=>{if(!g.current)return;const n=new M(g.current,{selection:!u,backgroundColor:"#1e293b"});p.current=n;const o=g.current.parentElement;if(!o)return;const y=new ResizeObserver(m=>{const{width:e,height:t}=m[0].contentRect;n.setWidth(e),n.setHeight(t),x()});return y.observe(o),x(),()=>{y.disconnect(),n.dispose(),p.current=null}},[u,x]),i.useEffect(()=>{x()},[R,c,v,E,I,d,x]),b.jsx("canvas",{ref:g,className:"w-full h-full"})}),_=({title:l,children:W})=>b.jsxs("div",{className:"bg-slate-800/20 backdrop-blur-xl border border-slate-700/50 rounded-xl shadow-xl h-full flex flex-col",children:[b.jsx("div",{className:"p-4 border-b border-slate-700/50",children:b.jsx("h3",{className:"text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-300 to-emerald-300",children:l})}),b.jsx("div",{className:"flex-grow p-1 relative",children:W})]});export{G as F,_ as V};
