import{m as Yt,r as k,R as qt,j as ne,A as Qt}from"./index-e439054e.js";import{a as X,E as Zt,b as Jt,P as wt,S as $t,U as en,c as re,M as G,d as Ze,e as Ce,W as Et,T as Xe,C as q,f as ke,g as tn,N as nn,h as xe,R as sn,D as se,B as $,i as _e,I as Rt,j as Ae,k as Je,l as Mt,m as Lt,n as bt,L as $e,o as _t,p as et,q as It,r as ye,s as St,Q as tt,t as rn,u as We,v as Nt,w as Ct,x as Ye,F as ve,y as ie,z as on,A as an,G as vt,H as Le,J as ue,V as J,K as cn,O as ln,X as kt,Y as Ot,Z as un,_ as hn,$ as dn,a0 as Oe,a1 as fn,a2 as te,a3 as Dt,a4 as pn,a5 as mn,a6 as gn,a7 as Tn,a8 as xn,a9 as ge,aa as An,ab as yn,ac as wn,ad as En,ae as st,af as Rn,ag as Mn,ah as rt,ai as it,aj as ot,ak as Ft,al as Ln,am as bn,an as _n,ao as In,ap as Sn,aq as Nn,ar as De,as as Pt,at as Ut,au as me,av as at}from"./OrbitControls-945b1259.js";import{D as Cn,P as vn,b as kn}from"./constants-81f60586.js";const de=new Jt(0,0,0,"YXZ"),fe=new X,On={type:"change"},Dn={type:"lock"},Fn={type:"unlock"},ct=Math.PI/2;class Pn extends Zt{constructor(e,t){super(),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Un.bind(this),this._onPointerlockChange=Gn.bind(this),this._onPointerlockError=Bn.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(e){return e.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(e){const t=this.camera;fe.setFromMatrixColumn(t.matrix,0),fe.crossVectors(t.up,fe),t.position.addScaledVector(fe,e)}moveRight(e){const t=this.camera;fe.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(fe,e)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Un(c){if(this.isLocked===!1)return;const e=c.movementX||c.mozMovementX||c.webkitMovementX||0,t=c.movementY||c.mozMovementY||c.webkitMovementY||0,r=this.camera;de.setFromQuaternion(r.quaternion),de.y-=e*.002*this.pointerSpeed,de.x-=t*.002*this.pointerSpeed,de.x=Math.max(ct-this.maxPolarAngle,Math.min(ct-this.minPolarAngle,de.x)),r.quaternion.setFromEuler(de),this.dispatchEvent(On)}function Gn(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(Dn),this.isLocked=!0):(this.dispatchEvent(Fn),this.isLocked=!1)}function Bn(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}let Ie,Fe,pe,Se;function Pe(c,e=1/0,t=null){Fe||(Fe=new wt(2,2,1,1)),pe||(pe=new $t({uniforms:{blitTexture:new en(c)},vertexShader:`
            varying vec2 vUv;
            void main(){
                vUv = uv;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
            }`})),pe.uniforms.blitTexture.value=c,pe.defines.IS_SRGB=c.colorSpace==re,pe.needsUpdate=!0,Se||(Se=new G(Fe,pe),Se.frustrumCulled=!1);const r=new Ze,n=new Ce;n.add(Se),t||(t=Ie=new Et({antialias:!1})),t.setSize(Math.min(c.image.width,e),Math.min(c.image.height,e)),t.clear(),t.render(n,r);const i=new Xe(t.domElement);return i.minFilter=c.minFilter,i.magFilter=c.magFilter,i.wrapS=c.wrapS,i.wrapT=c.wrapT,i.name=c.name,Ie&&(Ie.dispose(),Ie=null),i}const lt={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class nt{constructor(){this.pluginCallbacks=[],this.register(function(e){return new Qn(e)}),this.register(function(e){return new Zn(e)}),this.register(function(e){return new es(e)}),this.register(function(e){return new ts(e)}),this.register(function(e){return new ns(e)}),this.register(function(e){return new ss(e)}),this.register(function(e){return new Jn(e)}),this.register(function(e){return new $n(e)}),this.register(function(e){return new rs(e)}),this.register(function(e){return new is(e)}),this.register(function(e){return new os(e)}),this.register(function(e){return new as(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,n){const i=new qn,s=[];for(let o=0,a=this.pluginCallbacks.length;o<a;o++)s.push(this.pluginCallbacks[o](i));i.setPlugins(s),i.write(e,t,n).catch(r)}parseAsync(e,t){const r=this;return new Promise(function(n,i){r.parse(e,n,i,t)})}}const b={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},Ue="KHR_mesh_quantization",Y={};Y[Mt]=b.NEAREST;Y[Lt]=b.NEAREST_MIPMAP_NEAREST;Y[bt]=b.NEAREST_MIPMAP_LINEAR;Y[$e]=b.LINEAR;Y[_t]=b.LINEAR_MIPMAP_NEAREST;Y[et]=b.LINEAR_MIPMAP_LINEAR;Y[It]=b.CLAMP_TO_EDGE;Y[ye]=b.REPEAT;Y[St]=b.MIRRORED_REPEAT;const ut={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Hn=new q,ht=12,jn=1179937895,zn=2,dt=8,Kn=1313821514,Vn=5130562;function be(c,e){return c.length===e.length&&c.every(function(t,r){return t===e[r]})}function Xn(c){return new TextEncoder().encode(c).buffer}function Wn(c){return be(c.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function Yn(c,e,t){const r={min:new Array(c.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(c.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=e;n<e+t;n++)for(let i=0;i<c.itemSize;i++){let s;c.itemSize>4?s=c.array[n*c.itemSize+i]:(i===0?s=c.getX(n):i===1?s=c.getY(n):i===2?s=c.getZ(n):i===3&&(s=c.getW(n)),c.normalized===!0&&(s=xe.normalize(s,c.array))),r.min[i]=Math.min(r.min[i],s),r.max[i]=Math.max(r.max[i],s)}return r}function Gt(c){return Math.ceil(c/4)*4}function Ge(c,e=0){const t=Gt(c.byteLength);if(t!==c.byteLength){const r=new Uint8Array(t);if(r.set(new Uint8Array(c)),e!==0)for(let n=c.byteLength;n<t;n++)r[n]=e;return r.buffer}return c}function ft(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function pt(c,e){if(c.toBlob!==void 0)return new Promise(r=>c.toBlob(r,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),c.convertToBlob({type:e,quality:t})}class qn{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,r={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const n=this,i=n.buffers,s=n.json;r=n.options;const o=n.extensionsUsed,a=n.extensionsRequired,l=new Blob(i,{type:"application/octet-stream"}),h=Object.keys(o),u=Object.keys(a);if(h.length>0&&(s.extensionsUsed=h),u.length>0&&(s.extensionsRequired=u),s.buffers&&s.buffers.length>0&&(s.buffers[0].byteLength=l.size),r.binary===!0){const d=new FileReader;d.readAsArrayBuffer(l),d.onloadend=function(){const f=Ge(d.result),m=new DataView(new ArrayBuffer(dt));m.setUint32(0,f.byteLength,!0),m.setUint32(4,Vn,!0);const p=Ge(Xn(JSON.stringify(s)),32),g=new DataView(new ArrayBuffer(dt));g.setUint32(0,p.byteLength,!0),g.setUint32(4,Kn,!0);const T=new ArrayBuffer(ht),w=new DataView(T);w.setUint32(0,jn,!0),w.setUint32(4,zn,!0);const x=ht+g.byteLength+p.byteLength+m.byteLength+f.byteLength;w.setUint32(8,x,!0);const A=new Blob([T,g,p,m,f],{type:"application/octet-stream"}),M=new FileReader;M.readAsArrayBuffer(A),M.onloadend=function(){t(M.result)}}}else if(s.buffers&&s.buffers.length>0){const d=new FileReader;d.readAsDataURL(l),d.onloadend=function(){const f=d.result;s.buffers[0].uri=f,t(s)}}else t(s)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;const r=this.options,n=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&i.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(const s in i.gltfExtensions)t.extensions[s]=i.gltfExtensions[s],n[s]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+i.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){const n=new Map;n.set(!0,this.uid++),n.set(!1,this.uid++),this.uids.set(e,n)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const r=new X;for(let n=0,i=e.count;n<i;n++)if(Math.abs(r.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const r=e.clone(),n=new X;for(let i=0,s=r.count;i<s;i++)n.fromBufferAttribute(r,i),n.x===0&&n.y===0&&n.z===0?n.setX(1):n.normalize(),r.setXYZ(i,n.x,n.y,n.z);return t.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let r=!1;const n={};(t.offset.x!==0||t.offset.y!==0)&&(n.offset=t.offset.toArray(),r=!0),t.rotation!==0&&(n.rotation=t.rotation,r=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(n.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function r(f){return f.colorSpace===re?function(p){return p<.04045?p*.0773993808:Math.pow(p*.9478672986+.0521327014,2.4)}:function(p){return p}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof ke&&(e=Pe(e)),t instanceof ke&&(t=Pe(t));const n=e?e.image:null,i=t?t.image:null,s=Math.max(n?n.width:0,i?i.width:0),o=Math.max(n?n.height:0,i?i.height:0),a=ft();a.width=s,a.height=o;const l=a.getContext("2d");l.fillStyle="#00ffff",l.fillRect(0,0,s,o);const h=l.getImageData(0,0,s,o);if(n){l.drawImage(n,0,0,s,o);const f=r(e),m=l.getImageData(0,0,s,o).data;for(let p=2;p<m.length;p+=4)h.data[p]=f(m[p]/256)*256}if(i){l.drawImage(i,0,0,s,o);const f=r(t),m=l.getImageData(0,0,s,o).data;for(let p=1;p<m.length;p+=4)h.data[p]=f(m[p]/256)*256}l.putImageData(h,0,0);const d=(e||t).clone();return d.source=new tn(a),d.colorSpace=nn,d.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),d}processBuffer(e){const t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0}processBufferView(e,t,r,n,i){const s=this.json;s.bufferViews||(s.bufferViews=[]);let o;switch(t){case b.BYTE:case b.UNSIGNED_BYTE:o=1;break;case b.SHORT:case b.UNSIGNED_SHORT:o=2;break;default:o=4}const a=Gt(n*e.itemSize*o),l=new DataView(new ArrayBuffer(a));let h=0;for(let f=r;f<r+n;f++)for(let m=0;m<e.itemSize;m++){let p;e.itemSize>4?p=e.array[f*e.itemSize+m]:(m===0?p=e.getX(f):m===1?p=e.getY(f):m===2?p=e.getZ(f):m===3&&(p=e.getW(f)),e.normalized===!0&&(p=xe.normalize(p,e.array))),t===b.FLOAT?l.setFloat32(h,p,!0):t===b.INT?l.setInt32(h,p,!0):t===b.UNSIGNED_INT?l.setUint32(h,p,!0):t===b.SHORT?l.setInt16(h,p,!0):t===b.UNSIGNED_SHORT?l.setUint16(h,p,!0):t===b.BYTE?l.setInt8(h,p):t===b.UNSIGNED_BYTE&&l.setUint8(h,p),h+=o}const u={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:a};return i!==void 0&&(u.target=i),i===b.ARRAY_BUFFER&&(u.byteStride=e.itemSize*o),this.byteOffset+=a,s.bufferViews.push(u),{id:s.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),new Promise(function(n){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const s=Ge(i.result),o={buffer:t.processBuffer(s),byteOffset:t.byteOffset,byteLength:s.byteLength};t.byteOffset+=s.byteLength,n(r.bufferViews.push(o)-1)}})}processAccessor(e,t,r,n){const i=this.json,s={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let o;if(e.array.constructor===Float32Array)o=b.FLOAT;else if(e.array.constructor===Int32Array)o=b.INT;else if(e.array.constructor===Uint32Array)o=b.UNSIGNED_INT;else if(e.array.constructor===Int16Array)o=b.SHORT;else if(e.array.constructor===Uint16Array)o=b.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)o=b.BYTE;else if(e.array.constructor===Uint8Array)o=b.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(r===void 0&&(r=0),(n===void 0||n===1/0)&&(n=e.count),n===0)return null;const a=Yn(e,r,n);let l;t!==void 0&&(l=e===t.index?b.ELEMENT_ARRAY_BUFFER:b.ARRAY_BUFFER);const h=this.processBufferView(e,o,r,n,l),u={bufferView:h.id,byteOffset:h.byteOffset,componentType:o,count:n,max:a.max,min:a.min,type:s[e.itemSize]};return e.normalized===!0&&(u.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(u)-1}processImage(e,t,r,n="image/png"){if(e!==null){const i=this,s=i.cache,o=i.json,a=i.options,l=i.pending;s.images.has(e)||s.images.set(e,{});const h=s.images.get(e),u=n+":flipY/"+r.toString();if(h[u]!==void 0)return h[u];o.images||(o.images=[]);const d={mimeType:n},f=ft();f.width=Math.min(e.width,a.maxTextureSize),f.height=Math.min(e.height,a.maxTextureSize);const m=f.getContext("2d");if(r===!0&&(m.translate(0,f.height),m.scale(1,-1)),e.data!==void 0){t!==sn&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>a.maxTextureSize||e.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const g=new Uint8ClampedArray(e.height*e.width*4);for(let T=0;T<g.length;T+=4)g[T+0]=e.data[T+0],g[T+1]=e.data[T+1],g[T+2]=e.data[T+2],g[T+3]=e.data[T+3];m.putImageData(new ImageData(g,e.width,e.height),0,0)}else m.drawImage(e,0,0,f.width,f.height);a.binary===!0?l.push(pt(f,n).then(g=>i.processBufferViewImage(g)).then(g=>{d.bufferView=g})):f.toDataURL!==void 0?d.uri=f.toDataURL(n):l.push(pt(f,n).then(g=>new FileReader().readAsDataURL(g)).then(g=>{d.uri=g}));const p=o.images.push(d)-1;return h[u]=p,p}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const r={magFilter:Y[e.magFilter],minFilter:Y[e.minFilter],wrapS:Y[e.wrapS],wrapT:Y[e.wrapT]};return t.samplers.push(r)-1}processTexture(e){const r=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof ke&&(e=Pe(e,r.maxTextureSize));let s=e.userData.mimeType;s==="image/webp"&&(s="image/png");const o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,s)};e.name&&(o.name=e.name),this._invokeAll(function(l){l.writeTexture&&l.writeTexture(e,o)});const a=i.textures.push(o)-1;return n.textures.set(e,a),a}processMaterial(e){const t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);const n={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=e.color.toArray().concat([e.opacity]);if(be(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const o=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),a={index:this.processTexture(o),channel:o.channel};this.applyTextureTransform(a,o),n.pbrMetallicRoughness.metallicRoughnessTexture=a}if(e.map){const o={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(o,e.map),n.pbrMetallicRoughness.baseColorTexture=o}if(e.emissive){const o=e.emissive;if(Math.max(o.r,o.g,o.b)>0&&(n.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const l={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(l,e.emissiveMap),n.emissiveTexture=l}}if(e.normalMap){const o={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(o.scale=e.normalScale.x),this.applyTextureTransform(o,e.normalMap),n.normalTexture=o}if(e.aoMap){const o={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(o.strength=e.aoMapIntensity),this.applyTextureTransform(o,e.aoMap),n.occlusionTexture=o}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===se&&(n.doubleSided=!0),e.name!==""&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll(function(o){o.writeMaterial&&o.writeMaterial(e,n)});const s=r.materials.push(n)-1;return t.materials.set(e,s),s}processMesh(e){const t=this.cache,r=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let x=0,A=e.material.length;x<A;x++)n.push(e.material[x].uuid);else n.push(e.material.uuid);const i=n.join(":");if(t.meshes.has(i))return t.meshes.get(i);const s=e.geometry;let o;e.isLineSegments?o=b.LINES:e.isLineLoop?o=b.LINE_LOOP:e.isLine?o=b.LINE_STRIP:e.isPoints?o=b.POINTS:o=e.material.wireframe?b.LINES:b.TRIANGLES;const a={},l={},h=[],u=[],d={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},f=s.getAttribute("normal");f!==void 0&&!this.isNormalizedNormalAttribute(f)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(f)));let m=null;for(let x in s.attributes){if(x.slice(0,5)==="morph")continue;const A=s.attributes[x];if(x=d[x]||x.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),t.attributes.has(this.getUID(A))){l[x]=t.attributes.get(this.getUID(A));continue}m=null;const C=A.array;x==="JOINTS_0"&&!(C instanceof Uint16Array)&&!(C instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new $(new Uint16Array(C),A.itemSize,A.normalized));const v=this.processAccessor(m||A,s);v!==null&&(x.startsWith("_")||this.detectMeshQuantization(x,A),l[x]=v,t.attributes.set(this.getUID(A),v))}if(f!==void 0&&s.setAttribute("normal",f),Object.keys(l).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){const x=[],A=[],M={};if(e.morphTargetDictionary!==void 0)for(const C in e.morphTargetDictionary)M[e.morphTargetDictionary[C]]=C;for(let C=0;C<e.morphTargetInfluences.length;++C){const v={};let Q=!1;for(const B in s.morphAttributes){if(B!=="position"&&B!=="normal"){Q||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),Q=!0);continue}const z=s.morphAttributes[B][C],we=B.toUpperCase(),oe=s.attributes[B];if(t.attributes.has(this.getUID(z,!0))){v[we]=t.attributes.get(this.getUID(z,!0));continue}const ae=z.clone();if(!s.morphTargetsRelative)for(let H=0,y=z.count;H<y;H++)for(let E=0;E<z.itemSize;E++)E===0&&ae.setX(H,z.getX(H)-oe.getX(H)),E===1&&ae.setY(H,z.getY(H)-oe.getY(H)),E===2&&ae.setZ(H,z.getZ(H)-oe.getZ(H)),E===3&&ae.setW(H,z.getW(H)-oe.getW(H));v[we]=this.processAccessor(ae,s),t.attributes.set(this.getUID(oe,!0),v[we])}u.push(v),x.push(e.morphTargetInfluences[C]),e.morphTargetDictionary!==void 0&&A.push(M[C])}a.weights=x,A.length>0&&(a.extras={},a.extras.targetNames=A)}const p=Array.isArray(e.material);if(p&&s.groups.length===0)return null;const g=p?e.material:[e.material],T=p?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let x=0,A=T.length;x<A;x++){const M={mode:o,attributes:l};if(this.serializeUserData(s,M),u.length>0&&(M.targets=u),s.index!==null){let v=this.getUID(s.index);(T[x].start!==void 0||T[x].count!==void 0)&&(v+=":"+T[x].start+":"+T[x].count),t.attributes.has(v)?M.indices=t.attributes.get(v):(M.indices=this.processAccessor(s.index,s,T[x].start,T[x].count),t.attributes.set(v,M.indices)),M.indices===null&&delete M.indices}const C=this.processMaterial(g[T[x].materialIndex]);C!==null&&(M.material=C),h.push(M)}a.primitives=h,r.meshes||(r.meshes=[]),this._invokeAll(function(x){x.writeMesh&&x.writeMesh(e,a)});const w=r.meshes.push(a)-1;return t.meshes.set(i,w),w}detectMeshQuantization(e,t){if(this.extensionsUsed[Ue])return;let r;switch(t.array.constructor){case Int8Array:r="byte";break;case Uint8Array:r="unsigned byte";break;case Int16Array:r="short";break;case Uint16Array:r="unsigned short";break;default:return}t.normalized&&(r+=" normalized");const n=e.split("_",1)[0];lt[n]&&lt[n].includes(r)&&(this.extensionsUsed[Ue]=!0,this.extensionsRequired[Ue]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const r=e.isOrthographicCamera,n={type:r?"orthographic":"perspective"};return r?n.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:xe.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const r=this.json,n=this.nodeMap;r.animations||(r.animations=[]),e=nt.Utils.mergeMorphTargetTracks(e.clone(),t);const i=e.tracks,s=[],o=[];for(let a=0;a<i.length;++a){const l=i[a],h=_e.parseTrackName(l.name);let u=_e.findNode(t,h.nodeName);const d=ut[h.propertyName];if(h.objectName==="bones"&&(u.isSkinnedMesh===!0?u=u.skeleton.getBoneByName(h.objectIndex):u=void 0),!u||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name),null;const f=1;let m=l.values.length/l.times.length;d===ut.morphTargetInfluences&&(m/=u.morphTargetInfluences.length);let p;l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(p="CUBICSPLINE",m/=3):l.getInterpolation()===Rt?p="STEP":p="LINEAR",o.push({input:this.processAccessor(new $(l.times,f)),output:this.processAccessor(new $(l.values,m)),interpolation:p}),s.push({sampler:o.length-1,target:{node:n.get(u),path:d}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:o,channels:s}),r.animations.length-1}processSkin(e){const t=this.json,r=this.nodeMap,n=t.nodes[r.get(e)],i=e.skeleton;if(i===void 0)return null;const s=e.skeleton.bones[0];if(s===void 0)return null;const o=[],a=new Float32Array(i.bones.length*16),l=new Ae;for(let u=0;u<i.bones.length;++u)o.push(r.get(i.bones[u])),l.copy(i.boneInverses[u]),l.multiply(e.bindMatrix).toArray(a,u*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new $(a,16)),joints:o,skeleton:r.get(s)}),n.skin=t.skins.length-1}processNode(e){const t=this.json,r=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(r.trs){const o=e.quaternion.toArray(),a=e.position.toArray(),l=e.scale.toArray();be(o,[0,0,0,1])||(i.rotation=o),be(a,[0,0,0])||(i.translation=a),be(l,[1,1,1])||(i.scale=l)}else e.matrixAutoUpdate&&e.updateMatrix(),Wn(e.matrix)===!1&&(i.matrix=e.matrix.elements);if(e.name!==""&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const o=this.processMesh(e);o!==null&&(i.mesh=o)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const o=[];for(let a=0,l=e.children.length;a<l;a++){const h=e.children[a];if(h.visible||r.onlyVisible===!1){const u=this.processNode(h);u!==null&&o.push(u)}}o.length>0&&(i.children=o)}this._invokeAll(function(o){o.writeNode&&o.writeNode(e,i)});const s=t.nodes.push(i)-1;return n.set(e,s),s}processScene(e){const t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};e.name!==""&&(n.name=e.name),t.scenes.push(n);const i=[];for(let s=0,o=e.children.length;s<o;s++){const a=e.children[s];if(a.visible||r.onlyVisible===!1){const l=this.processNode(a);l!==null&&i.push(l)}}i.length>0&&(n.nodes=i),this.serializeUserData(e,n)}processObjects(e){const t=new Ce;t.name="AuxScene";for(let r=0;r<e.length;r++)t.children.push(e[r]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(n){n.beforeParse&&n.beforeParse(e)});const r=[];for(let n=0;n<e.length;n++)e[n]instanceof Ce?this.processScene(e[n]):r.push(e[n]);r.length>0&&this.processObjects(r);for(let n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll(function(n){n.afterParse&&n.afterParse(e)})}_invokeAll(e){for(let t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}}class Qn{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}const r=this.writer,n=r.json,i=r.extensionsUsed,s={};e.name&&(s.name=e.name),s.color=e.color.toArray(),s.intensity=e.intensity,e.isDirectionalLight?s.type="directional":e.isPointLight?(s.type="point",e.distance>0&&(s.range=e.distance)):e.isSpotLight&&(s.type="spot",e.distance>0&&(s.range=e.distance),s.spot={},s.spot.innerConeAngle=(1-e.penumbra)*e.angle,s.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},i[this.name]=!0);const o=n.extensions[this.name].lights;o.push(s),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}let Zn=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}},Jn=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;const r=this.writer,n=r.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const s={index:r.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};r.applyTextureTransform(s,e.clearcoatMap),i.clearcoatTexture=s}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const s={index:r.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};r.applyTextureTransform(s,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=s}if(e.clearcoatNormalMap){const s={index:r.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};r.applyTextureTransform(s,e.clearcoatNormalMap),i.clearcoatNormalTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},$n=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;const r=this.writer,n=r.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const s={index:r.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};r.applyTextureTransform(s,e.iridescenceMap),i.iridescenceTexture=s}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const s={index:r.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};r.applyTextureTransform(s,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},es=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const r=this.writer,n=r.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const s={index:r.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};r.applyTextureTransform(s,e.transmissionMap),i.transmissionTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},ts=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const r=this.writer,n=r.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const s={index:r.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};r.applyTextureTransform(s,e.thicknessMap),i.thicknessTexture=s}i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},ns=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;const n=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},ss=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Hn)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const r=this.writer,n=r.extensionsUsed,i={};if(e.specularIntensityMap){const s={index:r.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};r.applyTextureTransform(s,e.specularIntensityMap),i.specularTexture=s}if(e.specularColorMap){const s={index:r.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};r.applyTextureTransform(s,e.specularColorMap),i.specularColorTexture=s}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},rs=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;const r=this.writer,n=r.extensionsUsed,i={};if(e.sheenRoughnessMap){const s={index:r.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};r.applyTextureTransform(s,e.sheenRoughnessMap),i.sheenRoughnessTexture=s}if(e.sheenColorMap){const s={index:r.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};r.applyTextureTransform(s,e.sheenColorMap),i.sheenColorTexture=s}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},is=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.anisotropy==0)return;const r=this.writer,n=r.extensionsUsed,i={};if(e.anisotropyMap){const s={index:r.processTexture(e.anisotropyMap)};r.applyTextureTransform(s,e.anisotropyMap),i.anisotropyTexture=s}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},os=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;const n=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}},as=class{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const r=this.writer,n=e,i=new Float32Array(n.count*3),s=new Float32Array(n.count*4),o=new Float32Array(n.count*3),a=new Ae,l=new X,h=new tt,u=new X;for(let f=0;f<n.count;f++)n.getMatrixAt(f,a),a.decompose(l,h,u),l.toArray(i,f*3),h.toArray(s,f*4),u.toArray(o,f*3);const d={TRANSLATION:r.processAccessor(new $(i,3)),ROTATION:r.processAccessor(new $(s,4)),SCALE:r.processAccessor(new $(o,3))};n.instanceColor&&(d._COLOR_0=r.processAccessor(n.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:d},r.extensionsUsed[this.name]=!0,r.extensionsRequired[this.name]=!0}};nt.Utils={insertKeyframe:function(c,e){const r=c.getValueSize(),n=new c.TimeBufferType(c.times.length+1),i=new c.ValueBufferType(c.values.length+r),s=c.createInterpolant(new c.ValueBufferType(r));let o;if(c.times.length===0){n[0]=e;for(let a=0;a<r;a++)i[a]=0;o=0}else if(e<c.times[0]){if(Math.abs(c.times[0]-e)<.001)return 0;n[0]=e,n.set(c.times,1),i.set(s.evaluate(e),0),i.set(c.values,r),o=0}else if(e>c.times[c.times.length-1]){if(Math.abs(c.times[c.times.length-1]-e)<.001)return c.times.length-1;n[n.length-1]=e,n.set(c.times,0),i.set(c.values,0),i.set(s.evaluate(e),c.values.length),o=n.length-1}else for(let a=0;a<c.times.length;a++){if(Math.abs(c.times[a]-e)<.001)return a;if(c.times[a]<e&&c.times[a+1]>e){n.set(c.times.slice(0,a+1),0),n[a+1]=e,n.set(c.times.slice(a+1),a+2),i.set(c.values.slice(0,(a+1)*r),0),i.set(s.evaluate(e),(a+1)*r),i.set(c.values.slice((a+1)*r),(a+2)*r),o=a+1;break}}return c.times=n,c.values=i,o},mergeMorphTargetTracks:function(c,e){const t=[],r={},n=c.tracks;for(let i=0;i<n.length;++i){let s=n[i];const o=_e.parseTrackName(s.name),a=_e.findNode(e,o.nodeName);if(o.propertyName!=="morphTargetInfluences"||o.propertyIndex===void 0){t.push(s);continue}if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),s=s.clone(),s.setInterpolation(Je)}const l=a.morphTargetInfluences.length,h=a.morphTargetDictionary[o.propertyIndex];if(h===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+o.propertyIndex);let u;if(r[a.uuid]===void 0){u=s.clone();const f=new u.ValueBufferType(l*u.times.length);for(let m=0;m<u.times.length;m++)f[m*l+h]=u.values[m];u.name=(o.nodeName||"")+".morphTargetInfluences",u.values=f,r[a.uuid]=u,t.push(u);continue}const d=s.createInterpolant(new s.ValueBufferType(1));u=r[a.uuid];for(let f=0;f<u.times.length;f++)u.values[f*l+h]=d.evaluate(u.times[f]);for(let f=0;f<s.times.length;f++){const m=this.insertKeyframe(u,s.times[f]);u.values[m*l+h]=s.values[f]}}return c.tracks=t,c}};function mt(c,e){if(e===rn)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),c;if(e===We||e===Nt){let t=c.getIndex();if(t===null){const s=[],o=c.getAttribute("position");if(o!==void 0){for(let a=0;a<o.count;a++)s.push(a);c.setIndex(s),t=c.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),c}const r=t.count-2,n=[];if(e===We)for(let s=1;s<=r;s++)n.push(t.getX(0)),n.push(t.getX(s)),n.push(t.getX(s+1));else for(let s=0;s<r;s++)s%2===0?(n.push(t.getX(s)),n.push(t.getX(s+1)),n.push(t.getX(s+2))):(n.push(t.getX(s+2)),n.push(t.getX(s+1)),n.push(t.getX(s)));n.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=c.clone();return i.setIndex(n),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),c}class cs extends Ct{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new fs(t)}),this.register(function(t){return new ws(t)}),this.register(function(t){return new Es(t)}),this.register(function(t){return new Rs(t)}),this.register(function(t){return new ms(t)}),this.register(function(t){return new gs(t)}),this.register(function(t){return new Ts(t)}),this.register(function(t){return new xs(t)}),this.register(function(t){return new ds(t)}),this.register(function(t){return new As(t)}),this.register(function(t){return new ps(t)}),this.register(function(t){return new ys(t)}),this.register(function(t){return new us(t)}),this.register(function(t){return new Ms(t)}),this.register(function(t){return new Ls(t)})}load(e,t,r,n){const i=this;let s;this.resourcePath!==""?s=this.resourcePath:this.path!==""?s=this.path:s=Ye.extractUrlBase(e),this.manager.itemStart(e);const o=function(l){n?n(l):console.error(l),i.manager.itemError(e),i.manager.itemEnd(e)},a=new ve(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(l){try{i.parse(l,s,function(h){t(h),i.manager.itemEnd(e)},o)}catch(h){o(h)}},r,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,n){let i;const s={},o={},a=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Bt){try{s[_.KHR_BINARY_GLTF]=new bs(e)}catch(u){n&&n(u);return}i=JSON.parse(s[_.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new Gs(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const u=this.pluginCallbacks[h](l);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[u.name]=u,s[u.name]=!0}if(i.extensionsUsed)for(let h=0;h<i.extensionsUsed.length;++h){const u=i.extensionsUsed[h],d=i.extensionsRequired||[];switch(u){case _.KHR_MATERIALS_UNLIT:s[u]=new hs;break;case _.KHR_DRACO_MESH_COMPRESSION:s[u]=new _s(i,this.dracoLoader);break;case _.KHR_TEXTURE_TRANSFORM:s[u]=new Is;break;case _.KHR_MESH_QUANTIZATION:s[u]=new Ss;break;default:d.indexOf(u)>=0&&o[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(s),l.setPlugins(o),l.parse(r,n)}parseAsync(e,t){const r=this;return new Promise(function(n,i){r.parse(e,t,n,i)})}}function ls(){let c={};return{get:function(e){return c[e]},add:function(e,t){c[e]=t},remove:function(e){delete c[e]},removeAll:function(){c={}}}}const _={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class us{constructor(e){this.parser=e,this.name=_.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,n=t.length;r<n;r++){const i=t[r];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,r="light:"+e;let n=t.cache.get(r);if(n)return n;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let l;const h=new q(16777215);a.color!==void 0&&h.setRGB(a.color[0],a.color[1],a.color[2],ie);const u=a.range!==void 0?a.range:0;switch(a.type){case"directional":l=new vt(h),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new an(h),l.distance=u;break;case"spot":l=new on(h),l.distance=u,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,l.angle=a.spot.outerConeAngle,l.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return l.position.set(0,0,0),l.decay=2,le(l,a),a.intensity!==void 0&&(l.intensity=a.intensity),l.name=t.createUniqueName(a.name||"light_"+e),n=Promise.resolve(l),t.cache.add(r,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,i=r.json.nodes[e],o=(i.extensions&&i.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(a){return r._getNodeRef(t.cache,o,a)})}}class hs{constructor(){this.name=_.KHR_MATERIALS_UNLIT}getMaterialType(){return Le}extendParams(e,t,r){const n=[];e.color=new q(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const s=i.baseColorFactor;e.color.setRGB(s[0],s[1],s[2],ie),e.opacity=s[3]}i.baseColorTexture!==void 0&&n.push(r.assignTexture(e,"map",i.baseColorTexture,re))}return Promise.all(n)}}class ds{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class fs{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];if(s.clearcoatFactor!==void 0&&(t.clearcoat=s.clearcoatFactor),s.clearcoatTexture!==void 0&&i.push(r.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),s.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),s.clearcoatRoughnessTexture!==void 0&&i.push(r.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),s.clearcoatNormalTexture!==void 0&&(i.push(r.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),s.clearcoatNormalTexture.scale!==void 0)){const o=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new J(o,o)}return Promise.all(i)}}class ps{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.iridescenceFactor!==void 0&&(t.iridescence=s.iridescenceFactor),s.iridescenceTexture!==void 0&&i.push(r.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),s.iridescenceIor!==void 0&&(t.iridescenceIOR=s.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),s.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),s.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),s.iridescenceThicknessTexture!==void 0&&i.push(r.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(i)}}class ms{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new q(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=n.extensions[this.name];if(s.sheenColorFactor!==void 0){const o=s.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],ie)}return s.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=s.sheenRoughnessFactor),s.sheenColorTexture!==void 0&&i.push(r.assignTexture(t,"sheenColorMap",s.sheenColorTexture,re)),s.sheenRoughnessTexture!==void 0&&i.push(r.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(i)}}class gs{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.transmissionFactor!==void 0&&(t.transmission=s.transmissionFactor),s.transmissionTexture!==void 0&&i.push(r.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(i)}}class Ts{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];t.thickness=s.thicknessFactor!==void 0?s.thicknessFactor:0,s.thicknessTexture!==void 0&&i.push(r.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;const o=s.attenuationColor||[1,1,1];return t.attenuationColor=new q().setRGB(o[0],o[1],o[2],ie),Promise.all(i)}}class xs{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class As{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];t.specularIntensity=s.specularFactor!==void 0?s.specularFactor:1,s.specularTexture!==void 0&&i.push(r.assignTexture(t,"specularIntensityMap",s.specularTexture));const o=s.specularColorFactor||[1,1,1];return t.specularColor=new q().setRGB(o[0],o[1],o[2],ie),s.specularColorTexture!==void 0&&i.push(r.assignTexture(t,"specularColorMap",s.specularColorTexture,re)),Promise.all(i)}}class ys{constructor(e){this.parser=e,this.name=_.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:ue}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],s=n.extensions[this.name];return s.anisotropyStrength!==void 0&&(t.anisotropy=s.anisotropyStrength),s.anisotropyRotation!==void 0&&(t.anisotropyRotation=s.anisotropyRotation),s.anisotropyTexture!==void 0&&i.push(r.assignTexture(t,"anisotropyMap",s.anisotropyTexture)),Promise.all(i)}}class ws{constructor(e){this.parser=e,this.name=_.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,n=r.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],s=t.options.ktx2Loader;if(!s){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,s)}}class Es{constructor(e){this.parser=e,this.name=_.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,n=r.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const s=i.extensions[t],o=n.images[s.source];let a=r.textureLoader;if(o.uri){const l=r.options.manager.getHandler(o.uri);l!==null&&(a=l)}return this.detectSupport().then(function(l){if(l)return r.loadTextureImage(e,s.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Rs{constructor(e){this.parser=e,this.name=_.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,n=r.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const s=i.extensions[t],o=n.images[s.source];let a=r.textureLoader;if(o.uri){const l=r.options.manager.getHandler(o.uri);l!==null&&(a=l)}return this.detectSupport().then(function(l){if(l)return r.loadTextureImage(e,s.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Ms{constructor(e){this.name=_.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const n=r.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(o){const a=n.byteOffset||0,l=n.byteLength||0,h=n.count,u=n.byteStride,d=new Uint8Array(o,a,l);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(h,u,d,n.mode,n.filter).then(function(f){return f.buffer}):s.ready.then(function(){const f=new ArrayBuffer(h*u);return s.decodeGltfBuffer(new Uint8Array(f),h,u,d,n.mode,n.filter),f})})}else return null}}class Ls{constructor(e){this.name=_.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const n=t.meshes[r.mesh];for(const l of n.primitives)if(l.mode!==Z.TRIANGLES&&l.mode!==Z.TRIANGLE_STRIP&&l.mode!==Z.TRIANGLE_FAN&&l.mode!==void 0)return null;const s=r.extensions[this.name].attributes,o=[],a={};for(const l in s)o.push(this.parser.getDependency("accessor",s[l]).then(h=>(a[l]=h,a[l])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(l=>{const h=l.pop(),u=h.isGroup?h.children:[h],d=l[0].count,f=[];for(const m of u){const p=new Ae,g=new X,T=new tt,w=new X(1,1,1),x=new cn(m.geometry,m.material,d);for(let A=0;A<d;A++)a.TRANSLATION&&g.fromBufferAttribute(a.TRANSLATION,A),a.ROTATION&&T.fromBufferAttribute(a.ROTATION,A),a.SCALE&&w.fromBufferAttribute(a.SCALE,A),x.setMatrixAt(A,p.compose(g,T,w));for(const A in a)if(A==="_COLOR_0"){const M=a[A];x.instanceColor=new ln(M.array,M.itemSize,M.normalized)}else A!=="TRANSLATION"&&A!=="ROTATION"&&A!=="SCALE"&&m.geometry.setAttribute(A,a[A]);kt.prototype.copy.call(x,m),this.parser.assignFinalMaterial(x),f.push(x)}return h.isGroup?(h.clear(),h.add(...f),h):f[0]}))}}const Bt="glTF",Me=12,gt={JSON:1313821514,BIN:5130562};class bs{constructor(e){this.name=_.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Me),r=new TextDecoder;if(this.header={magic:r.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Bt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-Me,i=new DataView(e,Me);let s=0;for(;s<n;){const o=i.getUint32(s,!0);s+=4;const a=i.getUint32(s,!0);if(s+=4,a===gt.JSON){const l=new Uint8Array(e,Me+s,o);this.content=r.decode(l)}else if(a===gt.BIN){const l=Me+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class _s{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=_.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,o={},a={},l={};for(const h in s){const u=qe[h]||h.toLowerCase();o[u]=s[h]}for(const h in e.attributes){const u=qe[h]||h.toLowerCase();if(s[h]!==void 0){const d=r.accessors[e.attributes[h]],f=Te[d.componentType];l[u]=f.name,a[u]=d.normalized===!0}}return t.getDependency("bufferView",i).then(function(h){return new Promise(function(u){n.decodeDracoFile(h,function(d){for(const f in d.attributes){const m=d.attributes[f],p=a[f];p!==void 0&&(m.normalized=p)}u(d)},o,l)})})}}class Is{constructor(){this.name=_.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ss{constructor(){this.name=_.KHR_MESH_QUANTIZATION}}class Ht extends bn{constructor(e,t,r,n){super(e,t,r,n)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let s=0;s!==n;s++)t[s]=r[i+s];return t}interpolate_(e,t,r,n){const i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=o*2,l=o*3,h=n-t,u=(r-t)/h,d=u*u,f=d*u,m=e*l,p=m-l,g=-2*f+3*d,T=f-d,w=1-g,x=T-d+u;for(let A=0;A!==o;A++){const M=s[p+A+o],C=s[p+A+a]*h,v=s[m+A+o],Q=s[m+A]*h;i[A]=w*M+x*C+g*v+T*Q}return i}}const Ns=new tt;class Cs extends Ht{interpolate_(e,t,r,n){const i=super.interpolate_(e,t,r,n);return Ns.fromArray(i).normalize().toArray(i),i}}const Z={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Te={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Tt={9728:Mt,9729:$e,9984:Lt,9985:_t,9986:bt,9987:et},xt={33071:It,33648:St,10497:ye},Be={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ce={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},vs={CUBICSPLINE:void 0,LINEAR:Je,STEP:Rt},He={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function ks(c){return c.DefaultMaterial===void 0&&(c.DefaultMaterial=new te({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Rn})),c.DefaultMaterial}function he(c,e,t){for(const r in t.extensions)c[r]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=t.extensions[r])}function le(c,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(c.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Os(c,e,t){let r=!1,n=!1,i=!1;for(let l=0,h=e.length;l<h;l++){const u=e[l];if(u.POSITION!==void 0&&(r=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(i=!0),r&&n&&i)break}if(!r&&!n&&!i)return Promise.resolve(c);const s=[],o=[],a=[];for(let l=0,h=e.length;l<h;l++){const u=e[l];if(r){const d=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):c.attributes.position;s.push(d)}if(n){const d=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):c.attributes.normal;o.push(d)}if(i){const d=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):c.attributes.color;a.push(d)}}return Promise.all([Promise.all(s),Promise.all(o),Promise.all(a)]).then(function(l){const h=l[0],u=l[1],d=l[2];return r&&(c.morphAttributes.position=h),n&&(c.morphAttributes.normal=u),i&&(c.morphAttributes.color=d),c.morphTargetsRelative=!0,c})}function Ds(c,e){if(c.updateMorphTargets(),e.weights!==void 0)for(let t=0,r=e.weights.length;t<r;t++)c.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(c.morphTargetInfluences.length===t.length){c.morphTargetDictionary={};for(let r=0,n=t.length;r<n;r++)c.morphTargetDictionary[t[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Fs(c){let e;const t=c.extensions&&c.extensions[_.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+je(t.attributes):e=c.indices+":"+je(c.attributes)+":"+c.mode,c.targets!==void 0)for(let r=0,n=c.targets.length;r<n;r++)e+=":"+je(c.targets[r]);return e}function je(c){let e="";const t=Object.keys(c).sort();for(let r=0,n=t.length;r<n;r++)e+=t[r]+":"+c[t[r]]+";";return e}function Qe(c){switch(c){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Ps(c){return c.search(/\.jpe?g($|\?)/i)>0||c.search(/^data\:image\/jpeg/)===0?"image/jpeg":c.search(/\.webp($|\?)/i)>0||c.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const Us=new Ae;class Gs{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ls,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,n=!1,i=-1;typeof navigator<"u"&&(r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||r||n&&i<98?this.textureLoader=new Ot(this.options.manager):this.textureLoader=new un(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ve(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(s){return s._markDefs&&s._markDefs()}),Promise.all(this._invokeAll(function(s){return s.beforeRoot&&s.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(s){const o={scene:s[0][n.scene||0],scenes:s[0],animations:s[1],cameras:s[2],asset:n.asset,parser:r,userData:{}};return he(i,o,n),le(o,n),Promise.all(r._invokeAll(function(a){return a.afterRoot&&a.afterRoot(o)})).then(function(){e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n].joints;for(let o=0,a=s.length;o<a;o++)e[s[o]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const s=e[n];s.mesh!==void 0&&(this._addNodeRef(this.meshCache,s.mesh),s.skin!==void 0&&(r[s.mesh].isSkinnedMesh=!0)),s.camera!==void 0&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const n=r.clone(),i=(s,o)=>{const a=this.associations.get(s);a!=null&&this.associations.set(o,a);for(const[l,h]of s.children.entries())i(h,o.children[l])};return i(r,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const n=e(t[r]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&r.push(i)}return r}getDependency(e,t){const r=e+":"+t;let n=this.cache.get(r);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(r,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(i,s){return r.getDependency(e,s)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],r=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[_.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,s){r.load(Ye.resolveURL(t.uri,n.path),i,void 0,function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(r){const n=t.byteLength||0,i=t.byteOffset||0;return r.slice(i,i+n)})}loadAccessor(e){const t=this,r=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const s=Be[n.type],o=Te[n.componentType],a=n.normalized===!0,l=new o(n.count*s);return Promise.resolve(new $(l,s,a))}const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(s){const o=s[0],a=Be[n.type],l=Te[n.componentType],h=l.BYTES_PER_ELEMENT,u=h*a,d=n.byteOffset||0,f=n.bufferView!==void 0?r.bufferViews[n.bufferView].byteStride:void 0,m=n.normalized===!0;let p,g;if(f&&f!==u){const T=Math.floor(d/f),w="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+T+":"+n.count;let x=t.cache.get(w);x||(p=new l(o,T*f,n.count*f/h),x=new hn(p,f/h),t.cache.add(w,x)),g=new Mn(x,a,d%f/h,m)}else o===null?p=new l(n.count*a):p=new l(o,d,n.count*a),g=new $(p,a,m);if(n.sparse!==void 0){const T=Be.SCALAR,w=Te[n.sparse.indices.componentType],x=n.sparse.indices.byteOffset||0,A=n.sparse.values.byteOffset||0,M=new w(s[1],x,n.sparse.count*T),C=new l(s[2],A,n.sparse.count*a);o!==null&&(g=new $(g.array.slice(),g.itemSize,g.normalized));for(let v=0,Q=M.length;v<Q;v++){const B=M[v];if(g.setX(B,C[v*a]),a>=2&&g.setY(B,C[v*a+1]),a>=3&&g.setZ(B,C[v*a+2]),a>=4&&g.setW(B,C[v*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return g})}loadTexture(e){const t=this.json,r=this.options,i=t.textures[e].source,s=t.images[i];let o=this.textureLoader;if(s.uri){const a=r.manager.getHandler(s.uri);a!==null&&(o=a)}return this.loadTextureImage(e,i,o)}loadTextureImage(e,t,r){const n=this,i=this.json,s=i.textures[e],o=i.images[t],a=(o.uri||o.bufferView)+":"+s.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,r).then(function(h){h.flipY=!1,h.name=s.name||o.name||"",h.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(h.name=o.uri);const d=(i.samplers||{})[s.sampler]||{};return h.magFilter=Tt[d.magFilter]||$e,h.minFilter=Tt[d.minFilter]||et,h.wrapS=xt[d.wrapS]||ye,h.wrapT=xt[d.wrapT]||ye,n.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[a]=l,l}loadImageSource(e,t){const r=this,n=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const s=n.images[e],o=self.URL||self.webkitURL;let a=s.uri||"",l=!1;if(s.bufferView!==void 0)a=r.getDependency("bufferView",s.bufferView).then(function(u){l=!0;const d=new Blob([u],{type:s.mimeType});return a=o.createObjectURL(d),a});else if(s.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(a).then(function(u){return new Promise(function(d,f){let m=d;t.isImageBitmapLoader===!0&&(m=function(p){const g=new Xe(p);g.needsUpdate=!0,d(g)}),t.load(Ye.resolveURL(u,i.path),m,void 0,f)})}).then(function(u){return l===!0&&o.revokeObjectURL(a),u.userData.mimeType=s.mimeType||Ps(s.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),u});return this.sourceCache[e]=h,h}assignTexture(e,t,r,n){const i=this;return this.getDependency("texture",r.index).then(function(s){if(!s)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(s=s.clone(),s.channel=r.texCoord),i.extensions[_.KHR_TEXTURE_TRANSFORM]){const o=r.extensions!==void 0?r.extensions[_.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const a=i.associations.get(s);s=i.extensions[_.KHR_TEXTURE_TRANSFORM].extendTexture(s,o),i.associations.set(s,a)}}return n!==void 0&&(s.colorSpace=n),e[t]=s,s})}assignFinalMaterial(e){const t=e.geometry;let r=e.material;const n=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,s=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+r.uuid;let a=this.cache.get(o);a||(a=new dn,Oe.prototype.copy.call(a,r),a.color.copy(r.color),a.map=r.map,a.sizeAttenuation=!1,this.cache.add(o,a)),r=a}else if(e.isLine){const o="LineBasicMaterial:"+r.uuid;let a=this.cache.get(o);a||(a=new fn,Oe.prototype.copy.call(a,r),a.color.copy(r.color),a.map=r.map,this.cache.add(o,a)),r=a}if(n||i||s){let o="ClonedMaterial:"+r.uuid+":";n&&(o+="derivative-tangents:"),i&&(o+="vertex-colors:"),s&&(o+="flat-shading:");let a=this.cache.get(o);a||(a=r.clone(),i&&(a.vertexColors=!0),s&&(a.flatShading=!0),n&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(o,a),this.associations.set(a,this.associations.get(r))),r=a}e.material=r}getMaterialType(){return te}loadMaterial(e){const t=this,r=this.json,n=this.extensions,i=r.materials[e];let s;const o={},a=i.extensions||{},l=[];if(a[_.KHR_MATERIALS_UNLIT]){const u=n[_.KHR_MATERIALS_UNLIT];s=u.getMaterialType(),l.push(u.extendParams(o,i,t))}else{const u=i.pbrMetallicRoughness||{};if(o.color=new q(1,1,1),o.opacity=1,Array.isArray(u.baseColorFactor)){const d=u.baseColorFactor;o.color.setRGB(d[0],d[1],d[2],ie),o.opacity=d[3]}u.baseColorTexture!==void 0&&l.push(t.assignTexture(o,"map",u.baseColorTexture,re)),o.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,o.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(o,"metalnessMap",u.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",u.metallicRoughnessTexture))),s=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,o)})))}i.doubleSided===!0&&(o.side=se);const h=i.alphaMode||He.OPAQUE;if(h===He.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,h===He.MASK&&(o.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&s!==Le&&(l.push(t.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new J(1,1),i.normalTexture.scale!==void 0)){const u=i.normalTexture.scale;o.normalScale.set(u,u)}if(i.occlusionTexture!==void 0&&s!==Le&&(l.push(t.assignTexture(o,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&s!==Le){const u=i.emissiveFactor;o.emissive=new q().setRGB(u[0],u[1],u[2],ie)}return i.emissiveTexture!==void 0&&s!==Le&&l.push(t.assignTexture(o,"emissiveMap",i.emissiveTexture,re)),Promise.all(l).then(function(){const u=new s(o);return i.name&&(u.name=i.name),le(u,i),t.associations.set(u,{materials:e}),i.extensions&&he(n,u,i),u})}createUniqueName(e){const t=_e.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,r=this.extensions,n=this.primitiveCache;function i(o){return r[_.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(a){return At(a,o,t)})}const s=[];for(let o=0,a=e.length;o<a;o++){const l=e[o],h=Fs(l),u=n[h];if(u)s.push(u.promise);else{let d;l.extensions&&l.extensions[_.KHR_DRACO_MESH_COMPRESSION]?d=i(l):d=At(new Dt,l,t),n[h]={primitive:l,promise:d},s.push(d)}}return Promise.all(s)}loadMesh(e){const t=this,r=this.json,n=this.extensions,i=r.meshes[e],s=i.primitives,o=[];for(let a=0,l=s.length;a<l;a++){const h=s[a].material===void 0?ks(this.cache):this.getDependency("material",s[a].material);o.push(h)}return o.push(t.loadGeometries(s)),Promise.all(o).then(function(a){const l=a.slice(0,a.length-1),h=a[a.length-1],u=[];for(let f=0,m=h.length;f<m;f++){const p=h[f],g=s[f];let T;const w=l[f];if(g.mode===Z.TRIANGLES||g.mode===Z.TRIANGLE_STRIP||g.mode===Z.TRIANGLE_FAN||g.mode===void 0)T=i.isSkinnedMesh===!0?new pn(p,w):new G(p,w),T.isSkinnedMesh===!0&&T.normalizeSkinWeights(),g.mode===Z.TRIANGLE_STRIP?T.geometry=mt(T.geometry,Nt):g.mode===Z.TRIANGLE_FAN&&(T.geometry=mt(T.geometry,We));else if(g.mode===Z.LINES)T=new mn(p,w);else if(g.mode===Z.LINE_STRIP)T=new gn(p,w);else if(g.mode===Z.LINE_LOOP)T=new Tn(p,w);else if(g.mode===Z.POINTS)T=new xn(p,w);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(T.geometry.morphAttributes).length>0&&Ds(T,i),T.name=t.createUniqueName(i.name||"mesh_"+e),le(T,i),g.extensions&&he(n,T,g),t.assignFinalMaterial(T),u.push(T)}for(let f=0,m=u.length;f<m;f++)t.associations.set(u[f],{meshes:e,primitives:f});if(u.length===1)return i.extensions&&he(n,u[0],i),u[0];const d=new ge;i.extensions&&he(n,d,i),t.associations.set(d,{meshes:e});for(let f=0,m=u.length;f<m;f++)d.add(u[f]);return d})}loadCamera(e){let t;const r=this.json.cameras[e],n=r[r.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?t=new Ze(xe.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):r.type==="orthographic"&&(t=new An(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),le(t,r),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],r=[];for(let n=0,i=t.joints.length;n<i;n++)r.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(n){const i=n.pop(),s=n,o=[],a=[];for(let l=0,h=s.length;l<h;l++){const u=s[l];if(u){o.push(u);const d=new Ae;i!==null&&d.fromArray(i.array,l*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new yn(o,a)})}loadAnimation(e){const t=this.json,r=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,s=[],o=[],a=[],l=[],h=[];for(let u=0,d=n.channels.length;u<d;u++){const f=n.channels[u],m=n.samplers[f.sampler],p=f.target,g=p.node,T=n.parameters!==void 0?n.parameters[m.input]:m.input,w=n.parameters!==void 0?n.parameters[m.output]:m.output;p.node!==void 0&&(s.push(this.getDependency("node",g)),o.push(this.getDependency("accessor",T)),a.push(this.getDependency("accessor",w)),l.push(m),h.push(p))}return Promise.all([Promise.all(s),Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(h)]).then(function(u){const d=u[0],f=u[1],m=u[2],p=u[3],g=u[4],T=[];for(let w=0,x=d.length;w<x;w++){const A=d[w],M=f[w],C=m[w],v=p[w],Q=g[w];if(A===void 0)continue;A.updateMatrix&&A.updateMatrix();const B=r._createAnimationTracks(A,M,C,v,Q);if(B)for(let z=0;z<B.length;z++)T.push(B[z])}return new wn(i,void 0,T)})}createNodeMesh(e){const t=this.json,r=this,n=t.nodes[e];return n.mesh===void 0?null:r.getDependency("mesh",n.mesh).then(function(i){const s=r._getNodeRef(r.meshCache,n.mesh,i);return n.weights!==void 0&&s.traverse(function(o){if(o.isMesh)for(let a=0,l=n.weights.length;a<l;a++)o.morphTargetInfluences[a]=n.weights[a]}),s})}loadNode(e){const t=this.json,r=this,n=t.nodes[e],i=r._loadNodeShallow(e),s=[],o=n.children||[];for(let l=0,h=o.length;l<h;l++)s.push(r.getDependency("node",o[l]));const a=n.skin===void 0?Promise.resolve(null):r.getDependency("skin",n.skin);return Promise.all([i,Promise.all(s),a]).then(function(l){const h=l[0],u=l[1],d=l[2];d!==null&&h.traverse(function(f){f.isSkinnedMesh&&f.bind(d,Us)});for(let f=0,m=u.length;f<m;f++)h.add(u[f]);return h})}_loadNodeShallow(e){const t=this.json,r=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],s=i.name?n.createUniqueName(i.name):"",o=[],a=n._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return a&&o.push(a),i.camera!==void 0&&o.push(n.getDependency("camera",i.camera).then(function(l){return n._getNodeRef(n.cameraCache,i.camera,l)})),n._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){o.push(l)}),this.nodeCache[e]=Promise.all(o).then(function(l){let h;if(i.isBone===!0?h=new En:l.length>1?h=new ge:l.length===1?h=l[0]:h=new kt,h!==l[0])for(let u=0,d=l.length;u<d;u++)h.add(l[u]);if(i.name&&(h.userData.name=i.name,h.name=s),le(h,i),i.extensions&&he(r,h,i),i.matrix!==void 0){const u=new Ae;u.fromArray(i.matrix),h.applyMatrix4(u)}else i.translation!==void 0&&h.position.fromArray(i.translation),i.rotation!==void 0&&h.quaternion.fromArray(i.rotation),i.scale!==void 0&&h.scale.fromArray(i.scale);return n.associations.has(h)||n.associations.set(h,{}),n.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,r=this.json.scenes[e],n=this,i=new ge;r.name&&(i.name=n.createUniqueName(r.name)),le(i,r),r.extensions&&he(t,i,r);const s=r.nodes||[],o=[];for(let a=0,l=s.length;a<l;a++)o.push(n.getDependency("node",s[a]));return Promise.all(o).then(function(a){for(let h=0,u=a.length;h<u;h++)i.add(a[h]);const l=h=>{const u=new Map;for(const[d,f]of n.associations)(d instanceof Oe||d instanceof Xe)&&u.set(d,f);return h.traverse(d=>{const f=n.associations.get(d);f!=null&&u.set(d,f)}),u};return n.associations=l(i),i})}_createAnimationTracks(e,t,r,n,i){const s=[],o=e.name?e.name:e.uuid,a=[];ce[i.path]===ce.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(o);let l;switch(ce[i.path]){case ce.weights:l=it;break;case ce.rotation:l=ot;break;case ce.position:case ce.scale:l=rt;break;default:switch(r.itemSize){case 1:l=it;break;case 2:case 3:default:l=rt;break}break}const h=n.interpolation!==void 0?vs[n.interpolation]:Je,u=this._getArrayFromAccessor(r);for(let d=0,f=a.length;d<f;d++){const m=new l(a[d]+"."+ce[i.path],t.array,u,h);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),s.push(m)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const r=Qe(t.constructor),n=new Float32Array(t.length);for(let i=0,s=t.length;i<s;i++)n[i]=t[i]*r;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(r){const n=this instanceof ot?Cs:Ht;return new n(this.times,this.values,this.getValueSize()/3,r)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Bs(c,e,t){const r=e.attributes,n=new Ft;if(r.POSITION!==void 0){const o=t.json.accessors[r.POSITION],a=o.min,l=o.max;if(a!==void 0&&l!==void 0){if(n.set(new X(a[0],a[1],a[2]),new X(l[0],l[1],l[2])),o.normalized){const h=Qe(Te[o.componentType]);n.min.multiplyScalar(h),n.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const o=new X,a=new X;for(let l=0,h=i.length;l<h;l++){const u=i[l];if(u.POSITION!==void 0){const d=t.json.accessors[u.POSITION],f=d.min,m=d.max;if(f!==void 0&&m!==void 0){if(a.setX(Math.max(Math.abs(f[0]),Math.abs(m[0]))),a.setY(Math.max(Math.abs(f[1]),Math.abs(m[1]))),a.setZ(Math.max(Math.abs(f[2]),Math.abs(m[2]))),d.normalized){const p=Qe(Te[d.componentType]);a.multiplyScalar(p)}o.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(o)}c.boundingBox=n;const s=new Ln;n.getCenter(s.center),s.radius=n.min.distanceTo(n.max)/2,c.boundingSphere=s}function At(c,e,t){const r=e.attributes,n=[];function i(s,o){return t.getDependency("accessor",s).then(function(a){c.setAttribute(o,a)})}for(const s in r){const o=qe[s]||s.toLowerCase();o in c.attributes||n.push(i(r[s],o))}if(e.indices!==void 0&&!c.index){const s=t.getDependency("accessor",e.indices).then(function(o){c.setIndex(o)});n.push(s)}return st.workingColorSpace!==ie&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${st.workingColorSpace}" not supported.`),le(c,e),Bs(c,e,t),Promise.all(n).then(function(){return e.targets!==void 0?Os(c,e.targets,t):c})}const ze=new WeakMap;class Hs extends Ct{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,r,n){const i=new ve(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,s=>{this.parse(s,t,n)},r,n)}parse(e,t,r){this.decodeDracoFile(e,t,null,null,re).catch(r)}decodeDracoFile(e,t,r,n,i=ie){const s={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!r,vertexColorSpace:i};return this.decodeGeometry(e,s).then(t)}decodeGeometry(e,t){const r=JSON.stringify(t);if(ze.has(e)){const a=ze.get(e);if(a.key===r)return a.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const i=this.workerNextTaskID++,s=e.byteLength,o=this._getWorker(i,s).then(a=>(n=a,new Promise((l,h)=>{n._callbacks[i]={resolve:l,reject:h},n.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))).then(a=>this._createGeometry(a.geometry));return o.catch(()=>!0).then(()=>{n&&i&&this._releaseTask(n,i)}),ze.set(e,{key:r,promise:o}),o}_createGeometry(e){const t=new Dt;e.index&&t.setIndex(new $(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const n=e.attributes[r],i=n.name,s=n.array,o=n.itemSize,a=new $(s,o);i==="color"&&(this._assignVertexColorSpace(a,n.vertexColorSpace),a.normalized=!(s instanceof Float32Array)),t.setAttribute(i,a)}return t}_assignVertexColorSpace(e,t){if(t!==re)return;const r=new q;for(let n=0,i=e.count;n<i;n++)r.fromBufferAttribute(e,n).convertSRGBToLinear(),e.setXYZ(n,r.r,r.g,r.b)}_loadLibrary(e,t){const r=new ve(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((n,i)=>{r.load(e,n,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(r=>{const n=r[0];e||(this.decoderConfig.wasmBinary=r[1]);const i=js.toString(),s=["/* draco decoder */",n,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([s]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(i){const s=i.data;switch(s.type){case"decode":n._callbacks[s.id].resolve(s);break;case"error":n._callbacks[s.id].reject(s);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+s.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,i){return n._taskLoad>i._taskLoad?-1:1});const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function js(){let c,e;onmessage=function(s){const o=s.data;switch(o.type){case"init":c=o.decoderConfig,e=new Promise(function(h){c.onModuleLoaded=function(u){h({draco:u})},DracoDecoderModule(c)});break;case"decode":const a=o.buffer,l=o.taskConfig;e.then(h=>{const u=h.draco,d=new u.Decoder;try{const f=t(u,d,new Int8Array(a),l),m=f.attributes.map(p=>p.array.buffer);f.index&&m.push(f.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:f},m)}catch(f){console.error(f),self.postMessage({type:"error",id:o.id,error:f.message})}finally{u.destroy(d)}});break}};function t(s,o,a,l){const h=l.attributeIDs,u=l.attributeTypes;let d,f;const m=o.GetEncodedGeometryType(a);if(m===s.TRIANGULAR_MESH)d=new s.Mesh,f=o.DecodeArrayToMesh(a,a.byteLength,d);else if(m===s.POINT_CLOUD)d=new s.PointCloud,f=o.DecodeArrayToPointCloud(a,a.byteLength,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!f.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+f.error_msg());const p={index:null,attributes:[]};for(const g in h){const T=self[u[g]];let w,x;if(l.useUniqueIDs)x=h[g],w=o.GetAttributeByUniqueId(d,x);else{if(x=o.GetAttributeId(d,s[h[g]]),x===-1)continue;w=o.GetAttribute(d,x)}const A=n(s,o,d,g,T,w);g==="color"&&(A.vertexColorSpace=l.vertexColorSpace),p.attributes.push(A)}return m===s.TRIANGULAR_MESH&&(p.index=r(s,o,d)),s.destroy(d),p}function r(s,o,a){const h=a.num_faces()*3,u=h*4,d=s._malloc(u);o.GetTrianglesUInt32Array(a,u,d);const f=new Uint32Array(s.HEAPF32.buffer,d,h).slice();return s._free(d),{array:f,itemSize:1}}function n(s,o,a,l,h,u){const d=u.num_components(),m=a.num_points()*d,p=m*h.BYTES_PER_ELEMENT,g=i(s,h),T=s._malloc(p);o.GetAttributeDataArrayForAllPoints(a,u,g,p,T);const w=new h(s.HEAPF32.buffer,T,m).slice();return s._free(T),{name:l,array:w,itemSize:d}}function i(s,o){switch(o){case Float32Array:return s.DT_FLOAT32;case Int8Array:return s.DT_INT8;case Int16Array:return s.DT_INT16;case Int32Array:return s.DT_INT32;case Uint8Array:return s.DT_UINT8;case Uint16Array:return s.DT_UINT16;case Uint32Array:return s.DT_UINT32}}}const yt=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7D1BA","#E17F93","#BEAEE2"],zs=c=>{let e=0;for(let r=0;r<c.length;r++){const n=c.charCodeAt(r);e=(e<<5)-e+n,e=e&e}const t=Math.abs(e)%yt.length;return yt[t]},Ks=Yt.div,Vs=new Ot,Ke=new Map,Ne=new Map,jt=new cs,zt=new Hs;zt.setDecoderPath(Cn);jt.setDRACOLoader(zt);const Ve=new Map,Xs=(c,e={x:1,y:1})=>{if(Ke.has(c)){const r=Ke.get(c).clone();return r.repeat.set(e.x,e.y),r.needsUpdate=!0,r}const t=Vs.load(c);return t.wrapS=ye,t.wrapT=ye,t.repeat.set(e.x,e.y),Ke.set(c,t),t},Kt=(c,e="wall")=>{const t=kn.find(n=>n.key===c);if(!t)return new te({color:e==="floor"?8947848:13421772,side:se});const r={side:se};return t.type==="color"?r.color=new q(t.value):r.map=Xs(t.value,t.uvScale),t.metalness&&(r.metalness=t.metalness),t.roughness&&(r.roughness=t.roughness),new te(r)},Ws=(c,e,t,r)=>{const n=new ge,i=new J(c.x2-c.x1,c.y2-c.y1),s=i.length(),o=Math.atan2(i.y,i.x),a=Kt(c.material||(r==null?void 0:r.wallMaterialOverride),"wall");n.position.set((c.x1+c.x2)/2,c.height/2+t,-(c.y1+c.y2)/2),n.rotation.y=-o;let l=-s/2;const h=e.filter(d=>d.wallId===c.id).map(d=>{const f=d.positionRatio*s;return{start:f-d.width/2-s/2,end:f+d.width/2-s/2,height:d.height}}).sort((d,f)=>d.start-f.start);h.forEach(d=>{const f=d.start-l;if(f>.01){const p=new G(new me(f,c.height,c.thickness),a.clone());p.position.x=l+f/2,n.add(p)}const m=c.height-d.height;if(m>.01){const p=new G(new me(d.end-d.start,m,c.thickness),a.clone());p.position.x=d.start+(d.end-d.start)/2,p.position.y=c.height/2-m/2,n.add(p)}l=d.end});const u=s/2-l;if(u>.01){const d=new G(new me(u,c.height,c.thickness),a.clone());d.position.x=l+u/2,n.add(d)}if(h.length===0&&s>0){const d=new G(new me(s,c.height,c.thickness),a.clone());n.add(d)}return n},Ys=c=>{const e={residential:2450411,commercial:16096779,green_space:1096065,infrastructure:6583435},t=new Pt(c.path.map(s=>new J(s.x,-s.y))),r=new Ut(t),n=new te({color:e[c.type]||9741240,transparent:!0,opacity:.5,side:se}),i=new G(r,n);return i.rotation.x=-Math.PI/2,i.position.y=.5,i.userData={id:c.id,type:"zone"},i},qs=c=>{const e=new ge;e.userData={id:c.id,type:"infrastructure"};const t=new te({color:4674921});for(let r=0;r<c.path.length-1;r++){const n=c.path[r],i=c.path[r+1],s=new J(i.x-n.x,i.y-n.y),o=s.length(),a=Math.atan2(s.y,s.x),l=new me(o,2,c.width||10),h=new G(l,t);h.position.set(n.x+s.x/2,1,-(n.y+s.y/2)),h.rotation.y=-a,e.add(h)}return e},Qs=k.forwardRef((c,e)=>{var oe,ae,H;const t=k.useRef(null),{levels:r,activeLevelIndex:n,selectedObject:i,setSelectedObject:s,isWalkthroughActive:o,setIsWalkthroughActive:a,onAddHotspot:l,isHolocronAuthoringMode:h}=c,u=k.useRef(null),d=k.useRef(null),f=k.useRef(null),m=k.useRef(null),p=k.useRef(null),g=k.useRef(null),T=k.useRef(!1),w=k.useRef(!1),x=k.useRef(!1),A=k.useRef(!1),M=k.useRef(new X),C=k.useRef(new X),v=k.useRef(performance.now()),Q=k.useRef(o);k.useEffect(()=>{Q.current=o},[o]);const B=k.useRef(h);k.useEffect(()=>{B.current=h},[h]);const z=k.useMemo(()=>new te({color:16096779,emissive:11168779,side:se}),[]),we=k.useMemo(()=>new te({vertexColors:!0,side:se}),[]);return k.useEffect(()=>{if(!t.current)return;const y=t.current,E=new Ce;E.background=new q(1976635),d.current=E;const R=new Ze(75,y.clientWidth/y.clientHeight,.1,1e4);R.position.set(400,500,-600),f.current=R;const I=new Et({antialias:!0,preserveDrawingBuffer:!0});I.setSize(y.clientWidth,y.clientHeight),I.shadowMap.enabled=!0,I.shadowMap.type=_n,u.current=I,y.appendChild(I.domElement);const L=new In(R,I.domElement);L.enableDamping=!0,m.current=L;const S=new Sn(16777215,4473924,1.5);S.position.set(0,300,0),E.add(S);const N=new vt(16777215,2);N.position.set(150,200,100),N.castShadow=!0,N.shadow.camera.top=1e3,N.shadow.camera.bottom=-1e3,N.shadow.camera.left=-1e3,N.shadow.camera.right=1e3,E.add(N);const U=new Nn(2e3,50,4473924,4473924);E.add(U);const O=new ge;O.position.y=.1,p.current=O,E.add(O);const D=()=>{var P;if(requestAnimationFrame(D),Q.current&&((P=g.current)!=null&&P.isLocked)){const K=performance.now(),V=(K-v.current)/1e3;M.current.x-=M.current.x*10*V,M.current.z-=M.current.z*10*V,C.current.z=Number(T.current)-Number(w.current),C.current.x=Number(A.current)-Number(x.current),C.current.normalize(),(T.current||w.current)&&(M.current.z-=C.current.z*400*V),(x.current||A.current)&&(M.current.x-=C.current.x*400*V),g.current.moveRight(-M.current.x*V),g.current.moveForward(-M.current.z*V),g.current.getObject().position.y=r[n].elevation+160,v.current=K}else L.update();I.render(E,R)};D();const F=()=>{y&&u.current&&f.current&&(f.current.aspect=y.clientWidth/y.clientHeight,f.current.updateProjectionMatrix(),u.current.setSize(y.clientWidth,y.clientHeight))};window.addEventListener("resize",F);const j=P=>{if(Q.current||!t.current||!f.current||!p.current)return;const K=t.current.getBoundingClientRect(),V=new J;V.x=(P.clientX-K.left)/K.width*2-1,V.y=-((P.clientY-K.top)/K.height)*2+1;const Ee=new at;Ee.setFromCamera(V,f.current);const Re=Ee.intersectObjects(p.current.children,!0);if(Re.length>0){let W=Re[0].object;for(;W&&!W.userData.id;)W=W.parent;if(W&&W.userData.id){if(W.userData.type==="hotspot"&&c.onHotspotClick){c.onHotspotClick(W.userData.hotspotData);return}const{id:Vt,type:Xt,levelIndex:Wt}=W.userData;s({id:Vt,type:Xt,levelIndex:Wt})}}else s(null)};y.addEventListener("click",j);const ee=P=>{if(!B.current||!l||!t.current||!f.current||!p.current)return;const K=t.current.getBoundingClientRect(),V=new J;V.x=(P.clientX-K.left)/K.width*2-1,V.y=-((P.clientY-K.top)/K.height)*2+1;const Ee=new at;Ee.setFromCamera(V,f.current);const Re=Ee.intersectObjects(p.current.children,!0);if(Re.length>0){const W=Re[0].point;l({x:W.x,y:W.y,z:W.z})}};return y.addEventListener("dblclick",ee),()=>{var P;window.removeEventListener("resize",F),y.removeEventListener("click",j),y.removeEventListener("dblclick",ee),y&&u.current&&y.removeChild(u.current.domElement),(P=u.current)==null||P.dispose()}},[s,l]),k.useEffect(()=>{if(!(!u.current||!f.current||!d.current)&&o){const y=new Pn(f.current,u.current.domElement);g.current=y,d.current.add(y.getObject()),m.current.enabled=!1;const E=L=>{switch(L.code){case"KeyW":T.current=!0;break;case"KeyA":x.current=!0;break;case"KeyS":w.current=!0;break;case"KeyD":A.current=!0;break}},R=L=>{switch(L.code){case"KeyW":T.current=!1;break;case"KeyA":x.current=!1;break;case"KeyS":w.current=!1;break;case"KeyD":A.current=!1;break}},I=()=>{y.isLocked||a(!1)};return document.addEventListener("keydown",E),document.addEventListener("keyup",R),document.addEventListener("pointerlockchange",I),()=>{document.removeEventListener("keydown",E),document.removeEventListener("keyup",R),document.removeEventListener("pointerlockchange",I),d.current&&g.current&&d.current.remove(g.current.getObject()),m.current.enabled=!0}}},[o,a]),k.useLayoutEffect(()=>{const y=p.current;if(!y)return;for(;y.children.length;)y.remove(y.children[0]);const E=new wt(2e3,2e3),R=new De({opacity:.3}),I=new G(E,R);I.rotation.x=-Math.PI/2,I.receiveShadow=!0,y.add(I);const L=c.levels[c.activeLevelIndex];L&&(L.walls.forEach(S=>{const N=L.rooms.find(O=>O.wallIds.includes(S.id)),U=Ws(S,L.placements,L.elevation,N);U.traverse(O=>{O instanceof G&&(O.castShadow=!0,O.receiveShadow=!0)}),U.userData={id:S.id,type:"wall",levelIndex:c.activeLevelIndex},y.add(U)}),L.rooms.forEach(S=>{const N=S.wallIds.map(F=>L.walls.find(j=>j.id===F)).filter(Boolean);if(N.length<3)return;const U=[];N.forEach(F=>{U.push(new J(F.x1,F.y1)),U.push(new J(F.x2,F.y2))});const O=Array.from(new Set(U.map(F=>`${F.x},${F.y}`))).map(F=>{const[j,ee]=F.split(",").map(parseFloat);return new J(j,ee)}),D=O.reduce((F,j)=>F.add(j),new J).divideScalar(O.length);if(O.sort((F,j)=>Math.atan2(F.y-D.y,F.x-D.x)-Math.atan2(j.y-D.y,j.x-D.x)),O.length>2){const F=new Pt(O.map(K=>new J(K.x,-K.y))),j=new Ut(F),ee=Kt(S.floorMaterial,"floor"),P=new G(j,ee);P.rotation.x=-Math.PI/2,P.position.y=L.elevation+.5,P.userData={id:S.id,type:"room",levelIndex:c.activeLevelIndex,originalMaterial:ee},P.receiveShadow=!0,y.add(P)}}),(L.placedModels||[]).forEach(S=>{const N=vn.find(U=>U.key===S.modelKey);if(N)if(N.modelUrl){const U=O=>{const D=O.clone();D.position.set(S.x,L.elevation,-S.y),D.rotation.y=-xe.degToRad(S.rotation);const j=new Ft().setFromObject(D).getSize(new X),ee=Math.min(S.width/j.x,S.depth/j.z,S.height3d/j.y);D.scale.set(ee,ee,ee),D.traverse(P=>{P instanceof G&&(P.castShadow=!0,P.receiveShadow=!0)}),D.userData={id:S.id,type:"placedModel",levelIndex:c.activeLevelIndex},y.add(D)};Ve.has(N.modelUrl)?U(Ve.get(N.modelUrl)):jt.load(N.modelUrl,O=>{Ve.set(N.modelUrl,O.scene),U(O.scene)})}else{const U=new me(S.width,S.height3d,S.depth),O=new te({color:6583435}),D=new G(U,O);D.position.set(S.x,L.elevation+S.height3d/2,-S.y),D.rotation.y=-xe.degToRad(S.rotation),D.castShadow=!0,D.receiveShadow=!0,D.userData={id:S.id,type:"placedModel",levelIndex:c.activeLevelIndex},y.add(D)}})),(c.zones||[]).forEach(S=>{const N=Ys(S);y.add(N)}),(c.infrastructure||[]).forEach(S=>{if(S.type==="road"){const N=qs(S);N.traverse(U=>{U instanceof G&&(U.castShadow=!0)}),y.add(N)}})},[c.levels,c.activeLevelIndex,c.zones,c.infrastructure]),k.useLayoutEffect(()=>{const y=p.current;if(y&&(y.traverse(E=>{const R=E.userData;(R.type==="room"||R.type==="wall"||R.type==="road"||R.type==="zone"||R.type==="placedModel")&&E.traverse(I=>{I instanceof G&&I.userData.originalMaterial&&(I.material=I.userData.originalMaterial)})}),i&&i.levelIndex===n)){const E=y.children.find(R=>R.userData.id===i.id);E&&E.traverse(R=>{R instanceof G&&!(R instanceof De)&&(R.userData.originalMaterial=R.material,R.material=z)})}},[i,n,z]),k.useLayoutEffect(()=>{const y=d.current;y&&(Ne.forEach((E,R)=>{const I=y.getObjectByProperty("uuid",R);I&&(I.material=E)}),Ne.clear(),Object.values(c.liveSelections).forEach(E=>{var I;if(!E.objectId||E.userId===((I=c.currentUser)==null?void 0:I.id))return;const R=y.getObjectByProperty("userData",L=>L&&L.id===E.objectId);if(R){const L=new q(zs(E.userId)),S=new te({color:L,emissive:L,emissiveIntensity:.6,transparent:!0,opacity:.5,side:se});R.traverse(N=>{N instanceof G&&!(N instanceof De)&&(Ne.has(N.uuid)||Ne.set(N.uuid,N.material),N.material=S)})}}))},[c.liveSelections,(oe=c.currentUser)==null?void 0:oe.id]),k.useLayoutEffect(()=>{const y=p.current;y&&(y.traverse(E=>{if(E.userData.type==="wall"){const R=E.userData.originalMaterial;R&&(E.traverse(I=>{I instanceof G&&(I.material=R)}),delete E.userData.originalMaterial)}}),c.isDigitalTwinModeActive&&c.activeDataOverlays.stress&&c.digitalTwinData&&c.digitalTwinData.structuralStress.forEach(E=>{const R=y.children.find(I=>I.userData.id===E.wallId);if(R){const I=new q().setHSL(.3*(1-E.stressFactor),1,.5);R.traverse(L=>{L instanceof G&&(R.userData.originalMaterial||(R.userData.originalMaterial=L.material),L.material=new te({color:I,side:se}))})}}))},[c.isDigitalTwinModeActive,c.activeDataOverlays.stress,c.digitalTwinData,we]),qt.useImperativeHandle(e,()=>({exportAsPNG:()=>{var y;return(y=u.current)==null?void 0:y.domElement.toDataURL("image/png")},exportAsGLB:y=>{const E=new nt;p.current&&E.parse(p.current,R=>{if(!(R instanceof ArrayBuffer)){console.error("An error happened during GLB export: expected ArrayBuffer.");return}const I=new Blob([R],{type:"model/gltf-binary"}),L=document.createElement("a");L.href=URL.createObjectURL(I),L.download=`${y}.glb`,document.body.appendChild(L),L.click(),document.body.removeChild(L),URL.revokeObjectURL(L.href)},R=>{console.error("An error happened during GLB export:",R)},{binary:!0})}})),ne.jsxs("div",{className:"w-full h-full bg-slate-900 relative",ref:t,children:[h&&ne.jsx("div",{className:"absolute top-2 left-2 bg-purple-600/80 text-white text-xs font-semibold px-3 py-1 rounded-full animate-pulse z-10 pointer-events-none",children:"Hotspot Authoring Mode"}),ne.jsx(Qt,{children:o&&!((ae=g.current)!=null&&ae.isLocked)&&ne.jsx(Ks,{className:"absolute inset-0 bg-black/70 flex items-center justify-center cursor-pointer",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>{var y;return(y=g.current)==null?void 0:y.lock()},children:ne.jsx("p",{className:"text-white text-lg font-semibold",children:"Click to enter Walkthrough Mode"})})}),o&&((H=g.current)==null?void 0:H.isLocked)&&ne.jsxs(ne.Fragment,{children:[ne.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white text-2xl pointer-events-none",children:"+"}),ne.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 text-white text-sm bg-black/50 px-3 py-1 rounded-md pointer-events-none",children:"WASD to Move | ESC to Exit"})]})]})});Qs.displayName="Basic3dViewPanel";export{Qs as B,zs as g};
